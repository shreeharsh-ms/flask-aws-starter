name: CD

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: self-hosted   # make sure your self-hosted runner is online

    steps:
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Pull latest image
        run: |
          IMAGE_NAME=${{ secrets.DOCKER_USERNAME }}/flask-aws-starter-app-dev:latest
          docker pull $IMAGE_NAME

      - name: Stop and remove old container
        run: |
          docker ps -q --filter "name=flask-aws-starter-app-dev" | grep -q . && \
          docker stop flask-aws-starter-app-dev && \
          docker rm flask-aws-starter-app-dev || echo "No old container"

      - name: Run new container
        run: |
          IMAGE_NAME=${{ secrets.DOCKER_USERNAME }}/flask-aws-starter-app-dev:latest
          docker run -d --name flask-aws-starter-app-dev -p 80:5000 $IMAGE_NAME
